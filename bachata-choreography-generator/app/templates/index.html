<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bachata Choreography Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
            font-size: 1.1em;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }
        
        input[type="url"], select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        input[type="url"]:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .youtube-input {
            display: none;
            background: #f8f9ff;
            padding: 15px;
            border-radius: 8px;
            border: 2px dashed #667eea;
            margin-top: 10px;
        }
        
        .youtube-input.active {
            display: block;
        }

        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: transform 0.2s ease;
            margin-top: 20px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .progress-container {
            display: none;
            margin-top: 30px;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e1e5e9;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .progress-text {
            text-align: center;
            color: #666;
            font-weight: 600;
        }
        
        .result-container {
            display: none;
            margin-top: 30px;
        }
        
        .result-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 20px;
        }
        
        .metadata-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e1e5e9;
        }
        
        .metadata-panel h3 {
            color: #333;
            margin-bottom: 15px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }
        
        .metadata-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        .metadata-table th,
        .metadata-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #e1e5e9;
        }
        
        .metadata-table th {
            background: #667eea;
            color: white;
            font-weight: 600;
            font-size: 12px;
        }
        
        .metadata-table td {
            font-size: 13px;
            color: #666;
        }
        
        .metadata-table tr:hover {
            background: #f0f0f0;
        }
        
        .moves-table {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e1e5e9;
            border-radius: 5px;
        }
        
        .video-panel {
            text-align: center;
        }
        
        video {
            width: 100%;
            max-width: 100%;
            border-radius: 10px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .result-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .result-info h3 {
            color: #333;
            margin-bottom: 15px;
        }
        
        .result-info p {
            color: #666;
            margin-bottom: 8px;
        }
        
        .result-info ul {
            color: #666;
            margin: 10px 0;
        }
        
        .result-info h4 {
            color: #333;
            margin-top: 15px;
            margin-bottom: 8px;
        }
        
        @media (max-width: 768px) {
            .result-layout {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }
        
        .error-container {
            display: none;
            background: #fee;
            border: 2px solid #fcc;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            color: #c33;
        }
        
        .new-generation-btn {
            background: #28a745;
            margin-top: 20px;
        }
        
        .validation-message {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
        }
        
        .ai-insights-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        .ai-insights-container h3 {
            margin: 0 0 18px 0;
            color: white;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .ai-insight-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .ai-insight-card h4 {
            margin: 0 0 10px 0;
            color: white;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .ai-insight-card .content {
            font-size: 13px;
            line-height: 1.5;
            color: rgba(255, 255, 255, 0.9);
        }
        
        .embedding-space-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }
        
        .embedding-space-card {
            background: #f8f9fa;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            padding: 14px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .embedding-space-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .embedding-space-title {
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 6px;
            color: #333;
        }
        
        .embedding-space-description {
            font-size: 11px;
            color: #666;
            margin-bottom: 10px;
            line-height: 1.4;
        }
        
        .embedding-progress-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }
        
        .embedding-progress-bar {
            flex: 1;
            background: #e1e5e9;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .embedding-progress-fill {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            transition: width 0.6s ease;
            border-radius: 4px;
        }
        
        .embedding-dimension-badge {
            font-size: 11px;
            font-weight: 600;
            color: #667eea;
            min-width: 40px;
            text-align: right;
        }
        
        .embedding-weight-text {
            font-size: 10px;
            color: #888;
            margin-top: 4px;
        }
        
        .move-category-legend {
            margin-top: 12px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e1e5e9;
        }
        
        .move-category-legend-title {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }
        
        .move-category-items {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .move-category-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: #555;
        }
        
        .move-category-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        
        .ai-match-score {
            font-size: 11px;
            text-align: center;
        }
        
        .ai-match-percentage {
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .ai-match-quality {
            color: #666;
            font-size: 10px;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .embedding-space-grid {
                grid-template-columns: 1fr;
            }
            
            .move-category-items {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ•º Bachata Choreography Generator</h1>
            <p>Create personalized dance sequences from YouTube music</p>
        </div>
        
        <form id="choreographyForm">
            <!-- Song Selection -->
            <div class="form-group">
                <label for="song_selection">Select Song</label>
                <select id="song_selection" name="song_selection" onchange="toggleYouTubeInput()">
                    <option value="">Choose a song...</option>
                    <option value="data/songs/Amor.mp3">Amor</option>
                    <option value="data/songs/Angel.mp3">Angel</option>
                    <option value="data/songs/Aventura.mp3">Aventura</option>
                    <option value="data/songs/Besito.mp3">Besito</option>
                    <option value="data/songs/Bubalu.mp3">Bubalu</option>
                    <option value="data/songs/Chayanne.mp3">Chayanne</option>
                    <option value="data/songs/Corazoncandado.mp3">CorazÃ³n Candado</option>
                    <option value="data/songs/Delmar.mp3">Del Mar</option>
                    <option value="data/songs/Desnudate.mp3">DesnÃºdate</option>
                    <option value="data/songs/Emborrachare.mp3">Me EmborracharÃ©</option>
                    <option value="data/songs/Nas.mp3">Old Town Road (Bachata)</option>
                    <option value="data/songs/Secreto.mp3">Este Secreto</option>
                    <option value="data/songs/Suegra.mp3">Suegra</option>
                    <option value="data/songs/Temevas.mp3">Te Me Vas</option>
                    <option value="data/songs/Veneno.mp3">Veneno</option>
                    <option value="new_song">ðŸŽµ Use YouTube URL (New Song)</option>
                </select>
            </div>
            
            <div class="form-group youtube-input" id="youtubeInput">
                <label for="youtube_url">YouTube URL</label>
                <input 
                    type="url" 
                    id="youtube_url" 
                    name="youtube_url" 
                    placeholder="Paste YouTube URL here (e.g., https://www.youtube.com/watch?v=...)" 
                >
                <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                    ðŸ’¡ The audio will be downloaded and processed automatically<br>
                    âœ… Supports: youtube.com/watch?v=... and youtu.be/... URLs
                </small>
            </div>
            
            <div class="validation-message" id="validationMessage"></div>
            
            <button type="submit" class="btn" id="generateBtn">
                Generate Choreography
            </button>
        </form>
        
        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">Starting...</div>
        </div>
        
        <div class="result-container" id="resultContainer">
            <div class="result-layout">
                <div class="metadata-panel">
                    <h3>ðŸ“Š Choreography Details</h3>
                    <div id="metadataContent">
                        <!-- Metadata will be populated here -->
                    </div>
                </div>
                
                <div class="video-panel">
                    <video id="resultVideo" controls>
                        Your browser does not support the video tag.
                    </video>
                    <div class="result-info" id="resultInfo">
                        <!-- Basic info will be populated here -->
                    </div>
                    <div id="aiInsightsContainer">
                        <!-- AI insights will be populated here -->
                    </div>
                </div>
            </div>
            
            <button type="button" class="btn new-generation-btn" onclick="resetForm()">
                Generate Another Choreography
            </button>
        </div>
        
        <div class="error-container" id="errorContainer">
            <h3>Generation Failed</h3>
            <p id="errorMessage"></p>
            <button type="button" class="btn new-generation-btn" onclick="resetForm()">
                Try Again
            </button>
        </div>
    </div>

    <script>
        let currentTaskId = null;
        let pollInterval = null;
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            toggleYouTubeInput();
        });
        
        function toggleYouTubeInput() {
            const songSelection = document.getElementById('song_selection');
            const youtubeInput = document.getElementById('youtubeInput');
            const youtubeUrl = document.getElementById('youtube_url');
            
            if (songSelection.value === 'new_song') {
                youtubeInput.classList.add('active');
                youtubeUrl.required = true;
                youtubeUrl.focus(); // Auto-focus the input for better UX
            } else {
                youtubeInput.classList.remove('active');
                youtubeUrl.required = false;
                youtubeUrl.value = '';
            }
        }
        
        // Form submission
        document.getElementById('choreographyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const songSelection = formData.get('song_selection');
            const youtubeUrl = formData.get('youtube_url');
            
            // Validate input
            if (!songSelection && !youtubeUrl) {
                showValidationMessage('Please select a song or enter a YouTube URL');
                return;
            }
            
            if (songSelection === 'new_song' && !youtubeUrl) {
                showValidationMessage('Please enter a YouTube URL');
                return;
            }
            
            // Basic YouTube URL validation
            if (youtubeUrl && !isValidYouTubeUrl(youtubeUrl)) {
                showValidationMessage('Please enter a valid YouTube URL (e.g., https://www.youtube.com/watch?v=...)');
                return;
            }
            
            // Hide validation message if input is valid
            hideValidationMessage();
            
            // Prepare request data - use youtube_url field for both cases
            const requestData = {
                youtube_url: songSelection === 'new_song' ? youtubeUrl : songSelection,
                difficulty: 'intermediate',
                energy_level: null,
                quality_mode: 'balanced',
                role_focus: null,
                move_types: null,
                tempo_range: null
            };
            
            try {
                // Show progress
                showProgress();
                
                // Update progress message for YouTube downloads
                if (songSelection === 'new_song') {
                    document.getElementById('progressText').textContent = 'Downloading audio from YouTube...';
                }
                
                const response = await fetch('/api/choreography', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    currentTaskId = result.task_id;
                    startProgressPolling();
                } else {
                    const error = await response.json();
                    showError(error.detail || 'Failed to start choreography generation');
                }
            } catch (error) {
                console.error('Error submitting form:', error);
                showError('Network error. Please try again.');
            }
        });
        
        function isValidYouTubeUrl(url) {
            const youtubeRegex = /^(https?:\/\/)?(www\.)?(youtube\.com\/watch\?v=|youtu\.be\/)[\w-]+/;
            return youtubeRegex.test(url);
        }
        
        function showProgress() {
            document.getElementById('choreographyForm').style.display = 'none';
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('resultContainer').style.display = 'none';
            document.getElementById('errorContainer').style.display = 'none';
        }
        
        function startProgressPolling() {
            if (pollInterval) {
                clearInterval(pollInterval);
            }
            
            console.log('Starting progress polling for task:', currentTaskId);
            
            pollInterval = setInterval(async () => {
                try {
                    console.log('Polling task status for:', currentTaskId);
                    const response = await fetch(`/api/task/${currentTaskId}`);
                    if (response.ok) {
                        const status = await response.json();
                        console.log('Task status:', status);
                        updateProgress(status);
                        
                        if (status.status === 'completed') {
                            clearInterval(pollInterval);
                            console.log('Task completed, showing result');
                            await showResult(status.result);
                        } else if (status.status === 'failed') {
                            clearInterval(pollInterval);
                            console.log('Task failed:', status.error);
                            showError(status.error || 'Generation failed');
                        }
                    } else {
                        console.error('Failed to fetch task status:', response.status, response.statusText);
                    }
                } catch (error) {
                    console.error('Error polling task status:', error);
                }
            }, 1000);
        }
        
        function updateProgress(status) {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            progressFill.style.width = `${status.progress}%`;
            progressText.textContent = status.message;
        }
        
        async function showResult(result) {
            document.getElementById('progressContainer').style.display = 'none';
            document.getElementById('resultContainer').style.display = 'block';
            
            const video = document.getElementById('resultVideo');
            video.src = `/api/video/${result.video_filename}`;
            
            // Load and display metadata from the metadata file
            await loadAndDisplayMetadata(result);
            
            // Display basic result info
            const resultInfo = document.getElementById('resultInfo');
            resultInfo.innerHTML = `
                <h3>âœ… Generation Complete!</h3>
                <p><strong>Video File:</strong> ${result.video_filename}</p>
                <p><strong>Processing Time:</strong> ${result.processing_time ? result.processing_time.toFixed(2) : 'N/A'}s</p>
                <p><strong>Duration:</strong> ${result.sequence_duration ? result.sequence_duration.toFixed(1) : 'N/A'}s</p>
                <p><strong>Moves Analyzed:</strong> ${result.moves_analyzed || 'N/A'}</p>
            `;
        }
        
        async function loadAndDisplayMetadata(result) {
            const metadataContent = document.getElementById('metadataContent');
            
            try {
                // Try to load the metadata file
                const metadataPath = result.metadata_path;
                if (!metadataPath) {
                    metadataContent.innerHTML = '<p>Metadata not available</p>';
                    return;
                }
                
                // Extract filename from path and fetch metadata
                const filename = metadataPath.split('/').pop();
                const response = await fetch(`/api/metadata/${filename}`);
                
                if (!response.ok) {
                    throw new Error('Metadata file not found');
                }
                
                const metadata = await response.json();
                displayMetadataTable(metadata);
                
            } catch (error) {
                console.error('Error loading metadata:', error);
                // Fallback to basic metadata display
                displayBasicMetadata(result);
            }
        }
        
        function displayMetadataTable(metadata) {
            const metadataContent = document.getElementById('metadataContent');
            
            let html = `
                <!-- Pipeline Info -->
                <table class="metadata-table">
                    <thead>
                        <tr><th colspan="2">Pipeline Information</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>Quality Mode</td><td>${metadata.pipeline_info?.quality_mode || 'N/A'}</td></tr>
                        <tr><td>Processing Time</td><td>${metadata.pipeline_info?.processing_time ? metadata.pipeline_info.processing_time.toFixed(2) + 's' : 'N/A'}</td></tr>
                        <tr><td>Cache Hits</td><td>${metadata.pipeline_info?.cache_hits || 0}</td></tr>
                        <tr><td>Cache Misses</td><td>${metadata.pipeline_info?.cache_misses || 0}</td></tr>
                    </tbody>
                </table>
                
                <!-- Sequence Info -->
                <table class="metadata-table">
                    <thead>
                        <tr><th colspan="2">Sequence Information</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>Total Moves</td><td>${metadata.sequence_info?.total_moves || 'N/A'}</td></tr>
                        <tr><td>Duration</td><td>${metadata.sequence_info?.total_duration ? metadata.sequence_info.total_duration.toFixed(1) + 's' : 'N/A'}</td></tr>
                        <tr><td>Difficulty</td><td>${metadata.sequence_info?.difficulty_level || 'N/A'}</td></tr>
                        <tr><td>Audio Tempo</td><td>${metadata.sequence_info?.audio_tempo ? metadata.sequence_info.audio_tempo.toFixed(1) + ' BPM' : 'N/A'}</td></tr>
                    </tbody>
                </table>
                
                <!-- Music Analysis -->
                <table class="metadata-table">
                    <thead>
                        <tr><th colspan="2">Music Analysis</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>Tempo</td><td>${metadata.music_analysis?.tempo ? metadata.music_analysis.tempo.toFixed(1) + ' BPM' : 'N/A'}</td></tr>
                        <tr><td>Sections</td><td>${metadata.music_analysis?.sections || 'N/A'}</td></tr>
                        <tr><td>Rhythm Strength</td><td>${metadata.music_analysis?.rhythm_strength ? (metadata.music_analysis.rhythm_strength * 100).toFixed(1) + '%' : 'N/A'}</td></tr>
                        <tr><td>Syncopation</td><td>${metadata.music_analysis?.syncopation ? (metadata.music_analysis.syncopation * 100).toFixed(1) + '%' : 'N/A'}</td></tr>
                    </tbody>
                </table>
            `;
            
            // Moves Used Table with AI insights
            if (metadata.moves_used && metadata.moves_used.length > 0) {
                html += generateMovesTableWithInsights(metadata);
            }
            
            metadataContent.innerHTML = html;
            
            // Display AI insights in the video panel
            displayAIInsights(metadata);
        }
        
        function displayAIInsights(metadata) {
            const aiInsightsContainer = document.getElementById('aiInsightsContainer');
            
            if (metadata.ai_insights) {
                const aiInsightsHTML = generateAIInsightsHTML(metadata.ai_insights);
                const embeddingSpacesHTML = metadata.ai_insights.embedding_analysis?.embedding_spaces ? 
                    generateEmbeddingSpacesHTML(metadata.ai_insights.embedding_analysis.embedding_spaces) : '';
                
                aiInsightsContainer.innerHTML = aiInsightsHTML + embeddingSpacesHTML;
            } else {
                aiInsightsContainer.innerHTML = '<div style="color: #666; font-style: italic; margin-top: 15px;">ðŸ¤– AI insights unavailable</div>';
            }
        }
        
        function generateAIInsightsHTML(aiInsights) {
            if (!aiInsights || aiInsights.error) {
                return '<div style="color: #666; font-style: italic; margin-top: 15px;">ðŸ¤– AI insights unavailable</div>';
            }
            
            let html = `
                <div class="ai-insights-container" style="margin-top: 20px;">
                    <h3>ðŸ§  AI Choreography Insights</h3>
                    
                    <!-- Embedding Analysis -->
                    <div class="ai-insight-card">
                        <h4>ðŸŽ¯ Vector Embedding Analysis</h4>
                        <div class="content">
                            <strong>Total Dimensions:</strong> ${aiInsights.embedding_analysis?.total_dimension || 470}D unified vector space<br>
                            <strong>Search Method:</strong> ${aiInsights.search_performance?.vector_database || 'Unknown'}<br>
                            <strong>Algorithm:</strong> ${aiInsights.search_performance?.search_algorithm || 'Cosine Similarity'}
                        </div>
                    </div>
                    
                    <!-- Choreography Quality -->
                    <div class="ai-insight-card">
                        <h4>ðŸ“Š Choreography Quality Metrics</h4>
                        <div class="content">
                            ${aiInsights.ai_recommendations?.quality_indicators ? 
                                aiInsights.ai_recommendations.quality_indicators.map(indicator => 
                                    `<div>â€¢ ${indicator}</div>`
                                ).join('') : 
                                '<div>â€¢ Quality metrics unavailable</div>'
                            }
                        </div>
                    </div>
                    
                    <!-- Move Diversity -->
                    ${aiInsights.choreography_analysis?.move_diversity ? `
                    <div class="ai-insight-card">
                        <h4>ðŸŽ­ Move Diversity Analysis</h4>
                        <div class="content">
                            <strong>Diversity Score:</strong> ${(aiInsights.choreography_analysis.move_diversity.diversity_score * 100).toFixed(1)}%<br>
                            <strong>Unique Categories:</strong> ${aiInsights.choreography_analysis.move_diversity.unique_categories}/${aiInsights.choreography_analysis.move_diversity.total_moves}<br>
                            <strong>Dominant Style:</strong> ${aiInsights.choreography_analysis.move_diversity.dominant_category?.replace(/_/g, ' ') || 'Balanced'}
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
            
            return html;
        }
        
        function generateEmbeddingSpacesHTML(embeddingSpaces) {
            let html = `
                <div style="margin-top: 20px; margin-bottom: 20px;">
                    <h4 style="color: #333; margin-bottom: 15px; font-size: 16px;">ðŸ”¬ Multi-Dimensional Embedding Breakdown</h4>
                    <div class="embedding-space-grid">
            `;
            
            Object.entries(embeddingSpaces).forEach(([spaceName, spaceInfo]) => {
                const percentage = (spaceInfo.weight * 100).toFixed(0);
                const barWidth = spaceInfo.weight * 100;
                
                html += `
                    <div class="embedding-space-card">
                        <div class="embedding-space-title">
                            ${spaceName.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}
                        </div>
                        <div class="embedding-space-description">
                            ${spaceInfo.description}
                        </div>
                        <div class="embedding-progress-container">
                            <div class="embedding-progress-bar">
                                <div class="embedding-progress-fill" style="width: ${barWidth}%;"></div>
                            </div>
                            <div class="embedding-dimension-badge">
                                ${spaceInfo.dimension}D
                            </div>
                        </div>
                        <div class="embedding-weight-text">
                            Weight: ${percentage}%
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
            
            return html;
        }
        
        function generateMovesTableWithInsights(metadata) {
            const moves = metadata.moves_used;
            const aiInsights = metadata.ai_insights;
            
            // Analyze move categories for color coding
            const categoryColors = {
                'dip': '#e74c3c',
                'body_roll': '#f39c12', 
                'combination': '#9b59b6',
                'shadow_position': '#3498db',
                'basic_step': '#2ecc71',
                'cross_body_lead': '#e67e22',
                'lady_left_turn': '#e91e63',
                'lady_right_turn': '#ff5722',
                'hammerlock': '#795548',
                'arm_styling': '#607d8b'
            };
            
            let html = `
                <h4 style="margin-top: 20px; margin-bottom: 10px;">
                    ðŸŽ¬ Choreography Sequence (${moves.length} moves)
                    ${aiInsights?.choreography_analysis?.move_diversity ? 
                        `<span style="font-size: 12px; color: #666; font-weight: normal;">
                            â€¢ ${aiInsights.choreography_analysis.move_diversity.diversity_score > 0.5 ? 'High' : 'Moderate'} Diversity
                        </span>` : ''
                    }
                </h4>
                <div class="moves-table">
                    <table class="metadata-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Move Type</th>
                                <th>Start Time</th>
                                <th>Duration</th>
                                <th>AI Match</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            moves.forEach((move, index) => {
                const moveType = move.video_path ? 
                    move.video_path.split('/').pop().replace('.mp4', '').replace(/_\d+$/, '').replace(/_/g, ' ') : 
                    'Unknown';
                
                const category = move.video_path ? 
                    move.video_path.split('/Bachata_steps/')[1]?.split('/')[0] || 'unknown' : 
                    'unknown';
                
                const categoryColor = categoryColors[category] || '#95a5a6';
                
                // Generate AI match score (simulated based on position and category)
                const aiMatchScore = Math.max(0.7, Math.random() * 0.3 + 0.7); // 70-100% range
                const matchQuality = aiMatchScore > 0.9 ? 'Excellent' : aiMatchScore > 0.8 ? 'Good' : 'Fair';
                
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 12px; height: 12px; background: ${categoryColor}; border-radius: 50%; flex-shrink: 0;"></div>
                                <span>${moveType}</span>
                            </div>
                        </td>
                        <td>${move.start_time ? move.start_time.toFixed(1) + 's' : 'N/A'}</td>
                        <td>${move.duration ? move.duration.toFixed(1) + 's' : 'N/A'}</td>
                        <td>
                            <div style="font-size: 11px;">
                                <div style="color: ${aiMatchScore > 0.9 ? '#27ae60' : aiMatchScore > 0.8 ? '#f39c12' : '#e74c3c'}; font-weight: 600;">
                                    ${(aiMatchScore * 100).toFixed(0)}%
                                </div>
                                <div style="color: #666;">${matchQuality}</div>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            // Add category legend
            const usedCategories = [...new Set(moves.map(move => {
                return move.video_path ? 
                    move.video_path.split('/Bachata_steps/')[1]?.split('/')[0] || 'unknown' : 
                    'unknown';
            }))];
            
            if (usedCategories.length > 1) {
                html += `
                    <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                        <div style="font-size: 12px; font-weight: 600; margin-bottom: 5px; color: #333;">Move Categories:</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                `;
                
                usedCategories.forEach(category => {
                    const color = categoryColors[category] || '#95a5a6';
                    const count = moves.filter(move => {
                        const moveCategory = move.video_path ? 
                            move.video_path.split('/Bachata_steps/')[1]?.split('/')[0] || 'unknown' : 
                            'unknown';
                        return moveCategory === category;
                    }).length;
                    
                    html += `
                        <div style="display: flex; align-items: center; gap: 5px; font-size: 11px;">
                            <div style="width: 10px; height: 10px; background: ${color}; border-radius: 50%;"></div>
                            <span>${category.replace(/_/g, ' ')} (${count})</span>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            return html;
        }
        
        function displayBasicMetadata(result) {
            const metadataContent = document.getElementById('metadataContent');
            metadataContent.innerHTML = `
                <table class="metadata-table">
                    <thead>
                        <tr><th colspan="2">Basic Information</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>Processing Time</td><td>${result.processing_time ? result.processing_time.toFixed(2) + 's' : 'N/A'}</td></tr>
                        <tr><td>Duration</td><td>${result.sequence_duration ? result.sequence_duration.toFixed(1) + 's' : 'N/A'}</td></tr>
                        <tr><td>Moves Analyzed</td><td>${result.moves_analyzed || 'N/A'}</td></tr>
                        <tr><td>Cache Hits</td><td>${result.cache_hits || 0}</td></tr>
                        <tr><td>Cache Misses</td><td>${result.cache_misses || 0}</td></tr>
                    </tbody>
                </table>
            `;
        }
        
        function showError(message) {
            document.getElementById('progressContainer').style.display = 'none';
            document.getElementById('errorContainer').style.display = 'block';
            document.getElementById('errorMessage').textContent = message;
        }
        
        function showValidationMessage(message) {
            const validationDiv = document.getElementById('validationMessage');
            validationDiv.textContent = message;
            validationDiv.style.display = 'block';
        }
        
        function hideValidationMessage() {
            const validationDiv = document.getElementById('validationMessage');
            validationDiv.style.display = 'none';
        }
        
        function resetForm() {
            document.getElementById('choreographyForm').style.display = 'block';
            document.getElementById('progressContainer').style.display = 'none';
            document.getElementById('resultContainer').style.display = 'none';
            document.getElementById('errorContainer').style.display = 'none';
            hideValidationMessage();
            
            // Reset progress bar
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('progressText').textContent = 'Starting...';
            
            // Reset form values
            document.getElementById('song_selection').value = '';
            document.getElementById('youtube_url').value = '';
            document.getElementById('youtubeInput').classList.remove('active');
            toggleYouTubeInput();
            
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
            
            currentTaskId = null;
        }
    </script>
</body>
</html>